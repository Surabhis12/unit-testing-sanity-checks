name: Sanity Check Workflow

on:
  pull_request:
    branches:
      - "**"

jobs:
  sanity-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect language used in PR
        id: detect
        run: |
          echo "Detecting language from PR changes..."
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          LANGS=""

          for FILE in $FILES; do
            case "$FILE" in
              *.c|*.cpp|*.h) LANGS="$LANGS cpp" ;;
              *.js|*.jsx) LANGS="$LANGS js" ;;
              *.rs) LANGS="$LANGS rust" ;;
              *.kt) LANGS="$LANGS kotlin" ;;
              *.swift) LANGS="$LANGS swift" ;;
              *.java) LANGS="$LANGS java" ;;
              *.dart) LANGS="$LANGS flutter" ;;
            esac
          done

          echo "Detected languages: $LANGS"
          echo "langs=$LANGS" >> $GITHUB_OUTPUT

      - name: Run sanity checks
        id: sanity
        run: |
          set -e
          LANGS="${{ steps.detect.outputs.langs }}"
          RESULT=""

          for LANG in $LANGS; do
            case "$LANG" in
              cpp) ./scripts/run_cppcheck.sh || RESULT="FAIL" ;;
              js) ./scripts/run_eslint.sh || RESULT="FAIL" ;;
              rust) ./scripts/run_clippy.sh || RESULT="FAIL" ;;
              kotlin) ./scripts/run_ktlint.sh || RESULT="FAIL" ;;
              swift) ./scripts/run_swiftlint.sh || RESULT="FAIL" ;;
              java) ./scripts/run_javac.sh || RESULT="FAIL" ;;
              flutter) ./scripts/run_flutter_analyze.sh || RESULT="FAIL" ;;
            esac
          done

          if [ "$RESULT" = "FAIL" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
          else
            echo "status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Add PR comment
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: Sanity Check
          message: |
            ðŸ§ª **Sanity Check Results**
            - Status: **${{ steps.sanity.outputs.status }}**
            - Detected languages: ${{ steps.detect.outputs.langs }}

      - name: Label PR
        if: always()
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: |
            Sanity Check
