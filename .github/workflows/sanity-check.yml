name: Sanity Check Workflow

on:
  pull_request:
    branches:
      - "**"

# ✅ Fix 1: Grant workflow permissions to comment and label PRs
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  sanity-check:
    runs-on: ubuntu-latest

    steps:
      # ✅ Fix 2: Checkout full history (needed for git diff)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect language used in PR
        id: detect
        run: |
          echo "Detecting language from PR changes..."
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA || true)
          echo "Changed files:"
          echo "$FILES"

          LANGS=""

          for FILE in $FILES; do
            case "$FILE" in
              *.c|*.cpp|*.h) LANGS="$LANGS cpp" ;;
              *.js|*.jsx) LANGS="$LANGS js" ;;
              *.rs) LANGS="$LANGS rust" ;;
              *.kt) LANGS="$LANGS kotlin" ;;
              *.swift) LANGS="$LANGS swift" ;;
              *.java) LANGS="$LANGS java" ;;
              *.dart) LANGS="$LANGS flutter" ;;
            esac
          done

          if [ -z "$LANGS" ]; then
            echo "⚠️ No recognized languages found in PR. Exiting successfully."
            echo "langs=none" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Detected languages: $LANGS"
          echo "langs=$LANGS" >> $GITHUB_OUTPUT

      - name: Run sanity checks
        id: sanity
        if: ${{ steps.detect.outputs.langs != 'none' }}
        run: |
          set -e
          LANGS="${{ steps.detect.outputs.langs }}"
          RESULT="PASS"

          for LANG in $LANGS; do
            echo "Running checks for $LANG..."
            case "$LANG" in
              cpp)
                bash scripts/run_cppcheck.sh || RESULT="FAIL"
                ;;
              js)
                bash scripts/run_eslint.sh || RESULT="FAIL"
                ;;
              rust)
                bash scripts/run_clippy.sh || RESULT="FAIL"
                ;;
              kotlin)
                bash scripts/run_ktlint.sh || RESULT="FAIL"
                ;;
              swift)
                bash scripts/run_swiftlint.sh || RESULT="FAIL"
                ;;
              java)
                bash scripts/run_javac.sh || RESULT="FAIL"
                ;;
              flutter)
                bash scripts/run_flutter_analyze.sh || RESULT="FAIL"
                ;;
            esac
          done

          echo "Final result: $RESULT"
          echo "status=$RESULT" >> $GITHUB_OUTPUT

      # ✅ Fix 3: Comment on PR (now has permissions)
      - name: Add PR comment
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: Sanity Check
          message: |
            🧪 **Sanity Check Results**
            - Status: **${{ steps.sanity.outputs.status }}**
            - Detected languages: ${{ steps.detect.outputs.langs }}

      # ✅ Fix 4: Label PR (will work now with write permissions)
      - name: Label PR
        if: always()
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: |
            Sanity Check
